{% extends 'base.html' %}
{% load static %}

{% block title %}Список дисциплин | ПГУ им. "Шолом-Алейхема"{% endblock %}

{% block content %}
    <div class="ui container full-width">
        <div class="child-center">
            <div class="discipline-list cblock">
                <div class="content">
                    <h1 class="ui center aligned header">Список дисциплин</h1>
                    <div class="panel">
                        <div class="buttons left">
                            <div class="ui form">
                                <div class="inline fields">
                                    <div class="sixteen wide field">
                                        <label>Поиск</label>
                                        <input type="text" placeholder="Искать дисциплину..." name="search">
                                    </div>
                                    <div class="field">
                                        <a id="search-btn" class="medium ui primary button"><i class="search icon"></i></a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="buttons right">
                            <form id="download-xls" method="post">
                                {% csrf_token %}
                                <div class="sixteen wide">
                                    <a onclick="showModal()" class="large ui primary button">Залить xls</a>
                                    <button type="submit" class="large ui primary button">Скачать xls</button>
                                    <a href="{% static 'files/Shablon.xls' %}" class="large ui primary button"
                                       download="proposed_file_name">Скачать шаблон</a>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="sixteen wide table-container">


                        <table class="ui sortable celled table">
                            <thead>
                            <tr>
                                <th>Форма</th>
                                <th>Дисциплина</th>
                                <th>Факультет</th>
                                <th>Спец.</th>
                                <th>Курс</th>
                                <th>Сем.</th>
                                <th>Период</th>
                                <th>Труд.</th>
                                <th>Часов в нед.</th>
                                <th>Часов СРС</th>
                                <th>Часов по плану</th>
                                <th>ЛК</th>
                                <th>ПР</th>
                                <th>ЛР</th>
                                <th>Зачет</th>
                                <th>Экзамен</th>
                                <th>ВСЕГО</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for dis in disciplines %}
                                <tr>
                                    <td data-label="Форма">{{ dis.form.name }}</td>
                                    <td data-label="Дисциплина"><a
                                            href="/disciplines/{{ dis.id }}/nagruzka/">{{ dis.name }}</a>
                                    </td>
                                    <td data-label="Факультет">{{ dis.fakultet.name }}</td>
                                    <td data-label="Спец.">{{ dis.specialnost.name }}</td>
                                    <td data-label="Курс">{{ dis.kurs }}</td>
                                    <td data-label="Сем.">{{ dis.semestr }}</td>
                                    <td data-label="Период">{{ dis.period }}</td>
                                    <td data-label="Труд.">{{ dis.trudoemkost }}</td>
                                    <td data-label="Часов в нед.">{{ dis.chas_v_nedelu }}</td>
                                    <td data-label="Часов СРС">{{ dis.srs }}</td>
                                    <td data-label="Часов по плану">{{ dis.chas_po_planu }}</td>
                                    <td data-label="ЛК">{{ dis.lk }}</td>
                                    <td data-label="ПР">{{ dis.pr }}</td>
                                    <td data-label="ЛР">{{ dis.lr }}</td>
                                    <td data-label="Зачет">{{ dis.zachet }}</td>
                                    <td data-label="Экзамен">{{ dis.ekzamen }}</td>
                                    <td data-label="ВСЕГО">{{ dis.summary }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="ui modal">
        <div class="header">Выберите xls файл c дисциплинами</div>
        <div id="loader" class="ui inverted dimmer">
            <div class="ui text loader">Отправка файла...</div>
        </div>
        <div class="content no-shadow">
            <form id="disciplines-form" enctype="multipart/form-data" method="post" class="ui form">
                {% csrf_token %}
                <input type="hidden" name="action" value="update">
                <input id="disciplines-path" type="text" name="filename" readonly>
                <input id="disciplines-upload" type="file" name="disciplines" (change)="fileEvent($event)"
                       accept=".xls, .xlsx">
                <label for="disciplines-upload" class="ui medium primary right floated button">
                    <i class="ui upload icon"></i>
                    Выбрать
                </label>
            </form>
        </div>
        <div class="actions">
            <div id="replace" onclick="replaceDisciplines()" class="ui primary button">Отправить</div>
            <div class="ui cancel button" style="border-radius: 0">Отмена</div>
        </div>
    </div>
{% endblock %}
{% block script %}
    <script type="text/javascript" src="{% static 'js/table_sort.js' %}"></script>
    <script type="text/javascript">
        $('.ui.checkbox').checkbox();

        function showModal() {
            $('.ui.modal').modal('show')
        }

        function updateDisciplines() {
            $('input[name=action]').val('update');
            var $loader = $('#loader').addClass('active');
            sendDisciplines($loader);
        }

        function replaceDisciplines() {
            $('input[name=action]').val('replace');
            var $loader = $('#loader').addClass('active');
            sendDisciplines($loader);
        }

        function sendDisciplines($loader) {
            var formData = new FormData($('#disciplines-form').get(0));
            $.ajax({
                url: '{% url 'disciplines:upload' %}',
                type: 'post',
                data: formData,
                cache: false,
                processData: false,
                contentType: false,
                success: function (data) {
                    console.log(data);
                    $loader.removeClass('active');
                    window.location.reload();
                },
                error: function (data) {
                    $loader.removeClass('active');
                    window.location.reload();
                }
            })
        }

        function downloadURI(uri, name) {
            var link = document.createElement("a");
            link.download = name;
            link.href = uri;
            link.click();
        }

        $(document).ready(function () {
            $('#disciplines-upload').change(function () {
                var path = $(this).val().split('\\');
                $('#disciplines-path').val(path[path.length - 1]);
            });
            $('#download-xls').submit(function (e) {
                e.preventDefault();
                var formData = new FormData($(this).get(0));
                $.ajax({
                    url: '{% url 'disciplines:download' %}',
                    type: 'post',
                    data: formData,
                    cache: false,
                    processData: false,
                    contentType: false,
                    success: function (data) {
                        console.log(data);
                        downloadURI('{% static 'files/disciplines.xls' %}', 'disciplines.xls')
                    },
                    error: function (data) {
                    }
                })
            });
            $('table').tablesort()
            var $items = $('table tbody tr');
            var $list = $('table tbody');
            $('#search-btn').click(function () {
                var query = $('input[name=search]').val().split(' ');
                var $search_items = $items.filter(function () {
                    var result = true;
                    var disc = $(this).find('[data-label=Дисциплина]').text().toLowerCase();
                    query.forEach(function (val, i, a) {
                        result = disc.includes(val.toLowerCase());
                    });
                    return result
                });
                $list.html("");
                $list.append($search_items);
            })
        })
    </script>
{% endblock %}