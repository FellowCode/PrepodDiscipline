{% extends 'base.html' %}
{% load static %}

{% block title %}Список дисциплин | ПГУ им. "Шолом-Алейхема"{% endblock %}

{% block content %}
    <div class="ui container full-width">
        <div class="child-center">
            <div class="discipline-list cblock">
                <div class="content">
                    <h1 class="ui center aligned header">Доступные дисциплины для {{ prepod.fio }}</h1>
                    <form id="download-xls" method="post">
                        {% csrf_token %}
                        <div class="buttons">
                            <a onclick="showModal()" class="large ui primary button">Залить xls</a>
                            <button type="submit" class="large ui primary button">Скачать xls</button>
                            <a href="{% static 'files/Shablon.xls' %}" class="large ui primary button"
                               download="proposed_file_name">Скачать шаблон</a>
                        </div>
                        <div class="buttons">
                            <a onclick="showModal()" class="large ui primary button right">Сохранить</a>
                            <button type="submit" class="large ui primary button right">Снять выделение</button>
                            <a href="{% static 'files/Shablon.xls' %}" class="large ui primary button right"
                               download="proposed_file_name">Выделить все</a>
                        </div>
                    </form>

                    <div class="sixteen wide table-container">
                        <form id="disciplines" method="post">
                            <table class="ui celled table">
                                <thead>
                                <tr>
                                    <th>Форма</th>
                                    <th>Дисциплина</th>
                                    <th>Факультет</th>
                                    <th>Специальность</th>
                                    <th>Курс</th>
                                    <th>Семестр</th>
                                    <th>Период</th>
                                    <th>Трудоемкость</th>
                                    <th>Доступность</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for dis in disciplines %}
                                    <tr>
                                    <td data-label="Форма">{{ dis.form.name }}</td>
                                    <td data-label="Дисциплина">{{ dis.name }}</td>
                                    <td data-label="Факультет">{{ dis.fakultet.name }}</td>
                                    <td data-label="Специальность">{{ dis.specialnost.name }}</td>
                                    <td data-label="Курс">{{ dis.kurs }}</td>
                                    <td data-label="Семестр">{{ dis.semestr }}</td>
                                    <td data-label="Период">{{ dis.period }}</td>
                                    <td data-label="Трудоемкость">{{ dis.trudoemkost }}</td>
                                    <td data-label="Доступность">
                                        <div data-id="{{ dis.id }}"
                                             class="ui checkbox {% if prepod.discpl_available and pub.id in prepod.discpl_available.all %}checked{% endif %}">
                                            <input type="checkbox" tabindex="0" class="hidden"
                                                   {% if prepod.discpl_available and pub.id in prepod.discpl_available.all %}checked{% endif %}>
                                        </div>
                                    </td>
                                {% endfor %}
                                </tbody>
                            </table>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="ui modal">
        <div class="header">Выберите xls файл c дисциплинами</div>
        <div id="loader" class="ui inverted dimmer">
            <div class="ui text loader">Отправка файла...</div>
        </div>
        <div class="content no-shadow">
            <form id="disciplines-form" enctype="multipart/form-data" method="post" class="ui form">
                {% csrf_token %}
                <input type="hidden" name="action" value="update">
                <input id="disciplines-path" type="text" name="filename" readonly>
                <input id="disciplines-upload" type="file" name="disciplines" (change)="fileEvent($event)"
                       accept=".xls, .xlsx">
                <label for="disciplines-upload" class="ui medium primary right floated button">
                    <i class="ui upload icon"></i>
                    Выбрать
                </label>
            </form>
        </div>
        <div class="actions">
            <div id="update" onclick="updateDisciplines()" class="ui primary button">Обновить</div>
            <div id="replace" onclick="replaceDisciplines()" class="ui primary button">Заменить</div>
            <div class="ui cancel button" style="border-radius: 0">Отмена</div>
        </div>
    </div>
{% endblock %}
{% block script %}
    <script type="text/javascript">
        $('.ui.checkbox').checkbox();

        function showModal() {
            $('.ui.modal').modal('show')
        }

        function updateDisciplines() {
            $('input[name=action]').val('update');
            var $loader = $('#loader').addClass('active');
            sendDisciplines($loader);
        }

        function replaceDisciplines() {
            $('input[name=action]').val('replace');
            var $loader = $('#loader').addClass('active');
            sendDisciplines($loader);
        }

        function sendDisciplines($loader) {
            var formData = new FormData($('#disciplines-form').get(0));
            $.ajax({
                url: '{% url 'disciplines:upload' %}',
                type: 'post',
                data: formData,
                cache: false,
                processData: false,
                contentType: false,
                success: function (data) {
                    console.log(data);
                    $loader.removeClass('active');
                },
                error: function (data) {
                    $loader.removeClass('active');
                }
            })
        }

        function downloadURI(uri, name) {
            var link = document.createElement("a");
            link.download = name;
            link.href = uri;
            link.click();
        }

        $(document).ready(function () {
            $('#disciplines-upload').change(function () {
                var path = $(this).val().split('\\');
                $('#disciplines-path').val(path[path.length - 1]);
            });
            $('#download-xls').submit(function (e) {
                e.preventDefault();
                var formData = new FormData($(this).get(0));
                $.ajax({
                    url: '{% url 'disciplines:download' %}',
                    type: 'post',
                    data: formData,
                    cache: false,
                    processData: false,
                    contentType: false,
                    success: function (data) {
                        console.log(data);
                        downloadURI('{% static 'files/disciplines.xls' %}', 'disciplines.xls')
                    },
                    error: function (data) {
                    }
                })
            })
        })
    </script>
{% endblock %}